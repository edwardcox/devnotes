<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Notes v3.5</title>
    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <!-- Language support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1b23;
            --bg-secondary: #2d2e3f;
            --bg-tertiary: #373849;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --border: #3f4051;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            
            /* Category Colors */
            --cat-api: #f59e0b;
            --cat-config: #10b981;
            --cat-snippet: #6366f1;
            --cat-docs: #8b5cf6;
            --cat-notes: #06b6d4;
            --cat-security: #ef4444;
            --cat-database: #ec4899;
            --cat-other: #71717a;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            
            /* Adjusted category colors for light theme */
            --cat-api: #ea580c;
            --cat-config: #059669;
            --cat-snippet: #4f46e5;
            --cat-docs: #7c3aed;
            --cat-notes: #0891b2;
            --cat-security: #dc2626;
            --cat-database: #db2777;
            --cat-other: #4b5563;
        }

        /* Theme transition */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Quick transitions for interactive elements */
        button, input, select, textarea, .note-item, .category-filter {
            transition: all 0.2s ease;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .version-badge {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Category System */
        .category-filters {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-filter {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .category-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .category-filter.active {
            color: white;
            border-color: currentColor;
        }

        .category-filter.all.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .category-filter[data-category="api"].active {
            background: var(--cat-api);
            border-color: var(--cat-api);
        }

        .category-filter[data-category="config"].active {
            background: var(--cat-config);
            border-color: var(--cat-config);
        }

        .category-filter[data-category="snippet"].active {
            background: var(--cat-snippet);
            border-color: var(--cat-snippet);
        }

        .category-filter[data-category="docs"].active {
            background: var(--cat-docs);
            border-color: var(--cat-docs);
        }

        .category-filter[data-category="notes"].active {
            background: var(--cat-notes);
            border-color: var(--cat-notes);
        }

        .category-filter[data-category="security"].active {
            background: var(--cat-security);
            border-color: var(--cat-security);
        }

        .category-filter[data-category="database"].active {
            background: var(--cat-database);
            border-color: var(--cat-database);
        }

        .category-filter[data-category="other"].active {
            background: var(--cat-other);
            border-color: var(--cat-other);
        }

        .category-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .category-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-selector:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .note-category-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        .note-category-badge.api {
            background: var(--cat-api);
            color: white;
        }

        .note-category-badge.config {
            background: var(--cat-config);
            color: white;
        }

        .note-category-badge.snippet {
            background: var(--cat-snippet);
            color: white;
        }

        .note-category-badge.docs {
            background: var(--cat-docs);
            color: white;
        }

        .note-category-badge.notes {
            background: var(--cat-notes);
            color: white;
        }

        .note-category-badge.security {
            background: var(--cat-security);
            color: white;
        }

        .note-category-badge.database {
            background: var(--cat-database);
            color: white;
        }

        .note-category-badge.other {
            background: var(--cat-other);
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 0.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            position: relative;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .theme-toggle-track {
            width: 100%;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: 25px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
        }

        .theme-toggle-thumb {
            position: absolute;
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .theme-toggle-thumb {
            transform: translateX(44px);
        }

        .theme-icon {
            font-size: 1rem;
            z-index: 1;
            transition: opacity 0.3s ease;
        }

        .theme-icon.sun {
            color: #fbbf24;
        }

        .theme-icon.moon {
            color: #60a5fa;
        }

        [data-theme="light"] .theme-icon.sun {
            opacity: 1;
        }

        [data-theme="light"] .theme-icon.moon {
            opacity: 0.5;
        }

        [data-theme="dark"] .theme-icon.sun {
            opacity: 0.5;
        }

        [data-theme="dark"] .theme-icon.moon {
            opacity: 1;
        }

        /* Theme notification */
        .theme-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        /* Light theme adjustments */
        [data-theme="light"] .note-item {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .note-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .note-item.active {
            background: var(--bg-tertiary);
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
        }

        [data-theme="light"] .category-filter {
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .category-filter:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .code-preview,
        [data-theme="light"] .note-editor {
            background: white;
            color: var(--text-primary);
        }

        [data-theme="light"] pre[class*="language-"] {
            background: var(--bg-tertiary) !important;
        }

        [data-theme="light"] .markdown-preview {
            background: white;
        }

        [data-theme="light"] .markdown-preview pre {
            background: var(--bg-tertiary) !important;
            border-color: var(--border);
        }

        [data-theme="light"] .markdown-preview code {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        [data-theme="light"] .markdown-preview blockquote {
            background: var(--bg-tertiary);
            border-left-color: var(--accent);
        }

        [data-theme="light"] .modal-content,
        [data-theme="light"] .shortcuts-content,
        [data-theme="light"] .category-modal-content {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .note-tag {
            background: var(--bg-tertiary);
        }

        [data-theme="light"] .tag-item {
            background: white;
        }

        [data-theme="light"] .storage-status {
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .btn-secondary {
            background: white;
            border-color: var(--border);
        }

        [data-theme="light"] .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .shortcuts-modal.show {
            display: flex;
        }

        .shortcuts-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .shortcuts-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shortcuts-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: all 0.2s;
        }

        .shortcuts-close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .shortcuts-section {
            margin-bottom: 1.5rem;
        }

        .shortcuts-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .shortcut-description {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .shortcut-keys {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .key {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            min-width: 30px;
            text-align: center;
        }

        .key-plus {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin: 0 0.25rem;
        }

        /* Keyboard hints */
        .keyboard-hint {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            cursor: pointer;
            transition: all 0.2s;
        }

        .keyboard-hint:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Action notification */
        .action-notification {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--accent);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .action-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Focus styles for keyboard navigation */
        .note-item:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Category Management Modal */
        .category-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .category-modal.show {
            display: flex;
        }

        .category-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .category-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-list {
            margin-bottom: 2rem;
        }

        .category-item-edit {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .category-item-edit:hover {
            background: var(--bg-primary);
        }

        .category-icon-input {
            width: 50px;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            text-align: center;
            font-size: 1.2rem;
        }

        .category-name-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .category-color-input {
            width: 50px;
            height: 38px;
            padding: 0.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .category-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .category-btn-save {
            background: var(--accent);
            color: white;
        }

        .category-btn-save:hover {
            background: var(--accent-hover);
        }

        .category-btn-delete {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .category-btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .category-btn-cancel {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .category-btn-cancel:hover {
            background: var(--bg-primary);
        }

        .add-category-section {
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px dashed var(--border);
        }

        .add-category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .add-category-form {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .preset-colors {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .preset-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .preset-color:hover {
            transform: scale(1.1);
            border-color: var(--text-primary);
        }

        .preset-color.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px var(--text-primary);
        }

        .category-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--warning);
            font-size: 0.9rem;
        }

        .restore-defaults-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .manage-categories-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .manage-categories-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        /* Tags System */
        .tags-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .tags-input {
            flex: 1;
            min-width: 150px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .tags-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .tag-item {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            border: 1px solid var(--border);
        }

        .tag-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
            line-height: 1;
        }

        .tag-remove:hover {
            color: var(--danger);
        }

        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            margin-top: 0.3rem;
        }

        .note-tag {
            background: var(--bg-primary);
            color: var(--text-secondary);
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
        }

        /* Language Selector and View Mode */
        .editor-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .language-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .language-selector:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .view-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.25rem;
            border: 1px solid var(--border);
        }

        .view-toggle button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: var(--accent);
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: var(--bg-primary);
        }

        /* Code Preview Area */
        .code-preview {
            width: 100%;
            height: 100%;
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-y: auto;
            padding: 1rem;
        }

        .code-preview pre {
            margin: 0;
            background: transparent !important;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .code-preview code {
            background: transparent !important;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* Markdown Preview Styles */
        .markdown-preview {
            width: 100%;
            height: 100%;
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-y: auto;
            padding: 2rem;
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .markdown-preview h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 1.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--accent);
        }

        .markdown-preview h2 {
            font-size: 2rem;
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            color: var(--text-primary);
        }

        .markdown-preview h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            color: var(--text-primary);
        }

        .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: var(--text-primary);
        }

        .markdown-preview p {
            margin: 0 0 1rem 0;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin: 0 0 1rem 0;
            padding-left: 2rem;
        }

        .markdown-preview li {
            margin: 0.25rem 0;
        }

        .markdown-preview blockquote {
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-left: 4px solid var(--accent);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-style: italic;
        }

        .markdown-preview code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: var(--accent);
        }

        .markdown-preview pre {
            background: var(--bg-primary) !important;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .markdown-preview pre code {
            background: transparent;
            padding: 0;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .markdown-preview a {
            color: var(--accent);
            text-decoration: none;
            transition: all 0.2s;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
            color: var(--accent-hover);
        }

        .markdown-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .markdown-preview th {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--border);
            font-weight: 600;
        }

        .markdown-preview td {
            padding: 0.75rem;
            border: 1px solid var(--border);
        }

        .markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .markdown-preview hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }

        .markdown-preview mark {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
            padding: 0.2rem;
            border-radius: 3px;
        }

        .markdown-preview kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.2rem 0.4rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }

        /* Task lists */
        .markdown-preview input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Prism.js theme overrides for better integration */
        pre[class*="language-"] {
            background: var(--bg-secondary) !important;
            margin: 0;
        }

        code[class*="language-"] {
            text-shadow: none !important;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .storage-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .storage-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .storage-indicator.warning {
            background: var(--warning);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 73px); /* Subtract header height */
        }

        /* Sidebar */
        .sidebar {
            width: 30%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-stats {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-box {
            margin: 1rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .note-item {
            background: var(--bg-tertiary);
            margin: 0.5rem;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .note-item:hover {
            background: var(--bg-primary);
            transform: translateX(2px);
        }

        .note-item.active {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .note-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.3rem;
        }

        .note-item-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .note-item-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
        }

        .delete-note-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s;
        }

        .note-item:hover .delete-note-btn {
            opacity: 1;
        }

        .delete-note-btn:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Canvas Area */
        .canvas-area {
            width: 70%;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            height: 100%;
            overflow: hidden;
        }

        #canvasContent {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        .canvas-header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .note-title-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .note-title-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .save-indicator {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .note-editor-container {
            flex: 1;
            padding: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for Firefox */
        }

        .note-editor {
            width: 100%;
            height: 100%;
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: none;
            transition: all 0.2s;
            overflow-y: auto;
            min-height: 0; /* Important for proper flex sizing */
        }

        .note-editor:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Import/Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            width: 100%;
            padding: 2rem;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                width: 80%;
                height: 100%;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .canvas-area {
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .storage-status {
                display: none;
            }

            .theme-toggle {
                width: 60px;
            }
            
            .theme-toggle-track {
                padding: 0 4px;
            }
            
            .theme-toggle-thumb {
                width: 24px;
                height: 24px;
            }
            
            [data-theme="light"] .theme-toggle-thumb {
                transform: translateX(28px);
            }

            .keyboard-hint {
                display: none;
            }

            .shortcuts-content {
                padding: 1.5rem;
                max-width: 95%;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .overlay.show {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            
            .overlay {
                display: none !important;
            }
        }

        .mobile-menu-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .mobile-menu-btn:hover {
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>
                <h1 class="app-title">Dev Notes</h1>
                <span class="version-badge">v3.5</span>
            </div>
            <div class="header-actions">
                <div class="storage-status">
                    <div class="storage-indicator" id="storageIndicator"></div>
                    <span id="storageText">Ready</span>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme (Ctrl/Cmd + D)">
                    <div class="theme-toggle-track">
                        <span class="theme-icon sun">☀️</span>
                        <span class="theme-icon moon">🌙</span>
                    </div>
                    <div class="theme-toggle-thumb"></div>
                </div>
                <button class="btn btn-secondary" onclick="showShortcutsModal()" title="Keyboard Shortcuts (?)">
                    ⌨️
                </button>
                <button class="btn btn-secondary" onclick="showImportExportModal()">
                    📦 Import/Export
                </button>
                <button class="btn" onclick="createNewNote()">+ New Note</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <span class="note-stats" id="noteStats">No notes yet</span>
                    <button class="manage-categories-btn" onclick="showCategoryModal()">
                        ⚙️ Manage
                    </button>
                </div>
                <div class="category-filters" id="categoryFilters"></div>
                <div class="search-box">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput"
                        placeholder="Search notes and tags..."
                        oninput="searchNotes(this.value)"
                    />
                    <button class="search-clear" onclick="clearSearch()">✕</button>
                </div>
                <div class="notes-list" id="notesList"></div>
            </aside>

            <main class="canvas-area">
                <div id="canvasContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No note selected</div>
                        <div class="empty-state-subtext">Create a new note or select an existing one</div>
                    </div>
                </div>
            </main>
        </div>

        <div class="overlay" id="overlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Action Notification -->
        <div class="action-notification" id="actionNotification"></div>
        
        <!-- Theme Notification -->
        <div class="theme-notification" id="themeNotification"></div>
        
        <!-- Keyboard Hint -->
        <div class="keyboard-hint" onclick="showShortcutsModal()">
            ⌨️ Press <span class="key">?</span> for shortcuts
        </div>
        
        <!-- Keyboard Shortcuts Modal -->
        <div class="shortcuts-modal" id="shortcutsModal" onclick="if(event.target === this) closeShortcutsModal()">
            <div class="shortcuts-content">
                <div class="shortcuts-header">
                    <h2 class="shortcuts-title">
                        ⌨️ Keyboard Shortcuts
                    </h2>
                    <button class="shortcuts-close" onclick="closeShortcutsModal()">✕</button>
                </div>
                
                <div class="shortcuts-section">
                    <h3 class="shortcuts-section-title">📝 Note Management</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Create new note</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">N</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Save current note</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">S</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Delete current note</span>
                        <div class="shortcut-keys">
                            <span class="key">Shift</span>
                            <span class="key-plus">+</span>
                            <span class="key">Delete</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-section">
                    <h3 class="shortcuts-section-title">👁️ View & Navigation</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Toggle Theme (Light/Dark)</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">D</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Toggle Edit/Preview mode</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">E</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Focus search</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">/</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Next note</span>
                        <div class="shortcut-keys">
                            <span class="key">Alt</span>
                            <span class="key-plus">+</span>
                            <span class="key">↓</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Previous note</span>
                        <div class="shortcut-keys">
                            <span class="key">Alt</span>
                            <span class="key-plus">+</span>
                            <span class="key">↑</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-section">
                    <h3 class="shortcuts-section-title">🎯 Quick Actions</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Import/Export notes</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">I</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Focus title</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">T</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Focus editor</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">F</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Add tag</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">G</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Manage categories</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">M</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-section">
                    <h3 class="shortcuts-section-title">ℹ️ Help</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Show this help</span>
                        <div class="shortcut-keys">
                            <span class="key">?</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-description">Close dialogs</span>
                        <div class="shortcut-keys">
                            <span class="key">Esc</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center;">
                        💡 Tip: On Mac, use <span class="key">Cmd</span> instead of <span class="key">Ctrl</span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Category Management Modal -->
        <div class="category-modal" id="categoryModal" onclick="if(event.target === this) closeCategoryModal()">
            <div class="category-modal-content">
                <div class="category-modal-header">
                    <h2 class="category-modal-title">🎨 Manage Categories</h2>
                    <button class="shortcuts-close" onclick="closeCategoryModal()">✕</button>
                </div>
                
                <div class="category-list" id="categoryList">
                    <!-- Categories will be rendered here -->
                </div>
                
                <div class="add-category-section">
                    <h3 class="add-category-title">➕ Add New Category</h3>
                    <div class="add-category-form">
                        <input 
                            type="text" 
                            class="category-icon-input" 
                            id="newCategoryIcon"
                            placeholder="📁"
                            maxlength="2"
                            value="📁"
                        />
                        <input 
                            type="text" 
                            class="category-name-input" 
                            id="newCategoryName"
                            placeholder="Category name..."
                        />
                        <input 
                            type="color" 
                            class="category-color-input" 
                            id="newCategoryColor"
                            value="#71717a"
                        />
                        <button class="category-btn category-btn-save" onclick="addNewCategory()">
                            Add Category
                        </button>
                    </div>
                    <div class="preset-colors">
                        <div class="preset-color" style="background: #f59e0b" onclick="selectPresetColor('#f59e0b')"></div>
                        <div class="preset-color" style="background: #10b981" onclick="selectPresetColor('#10b981')"></div>
                        <div class="preset-color" style="background: #6366f1" onclick="selectPresetColor('#6366f1')"></div>
                        <div class="preset-color" style="background: #8b5cf6" onclick="selectPresetColor('#8b5cf6')"></div>
                        <div class="preset-color" style="background: #06b6d4" onclick="selectPresetColor('#06b6d4')"></div>
                        <div class="preset-color" style="background: #ef4444" onclick="selectPresetColor('#ef4444')"></div>
                        <div class="preset-color" style="background: #ec4899" onclick="selectPresetColor('#ec4899')"></div>
                        <div class="preset-color" style="background: #71717a" onclick="selectPresetColor('#71717a')"></div>
                        <div class="preset-color" style="background: #22c55e" onclick="selectPresetColor('#22c55e')"></div>
                        <div class="preset-color" style="background: #3b82f6" onclick="selectPresetColor('#3b82f6')"></div>
                        <div class="preset-color" style="background: #a855f7" onclick="selectPresetColor('#a855f7')"></div>
                        <div class="preset-color" style="background: #eab308" onclick="selectPresetColor('#eab308')"></div>
                    </div>
                </div>
                
                <div class="restore-defaults-section">
                    <button class="btn btn-secondary" onclick="restoreDefaultCategories()">
                        🔄 Restore Default Categories
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Import/Export Modal -->
        <div class="modal" id="importExportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Import/Export Notes</h2>
                </div>
                <div class="modal-body">
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Export Notes</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Download all your notes as a JSON file for backup or transfer.
                    </p>
                    <button class="btn" onclick="exportNotes()" style="width: 100%; margin-bottom: 2rem;">
                        💾 Export All Notes
                    </button>
                    
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Import Notes</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Import notes from a previously exported JSON file.
                    </p>
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            class="file-input" 
                            id="importFile"
                            accept=".json"
                            onchange="importNotes(this.files[0])"
                        />
                        <label for="importFile" class="file-input-label">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📁</div>
                            <div>Click to select file or drag and drop</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                JSON files only
                            </div>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeImportExportModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Storage Layer - Handles persistence
        class StorageManager {
            constructor() {
                this.notesKey = 'devNotes_v3';
                this.categoriesKey = 'devNotes_categories_v1';
                this.themeKey = 'devNotes_theme_v1';
                this.isStorageAvailable = this.checkStorageAvailability();
            }

            checkStorageAvailability() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    console.warn('localStorage not available, using in-memory storage');
                    return false;
                }
            }

            save(notes) {
                if (this.isStorageAvailable) {
                    try {
                        localStorage.setItem(this.notesKey, JSON.stringify(notes));
                        this.updateStorageStatus('saved');
                        return true;
                    } catch (e) {
                        console.error('Failed to save to localStorage:', e);
                        this.updateStorageStatus('error');
                        return false;
                    }
                } else {
                    // Fallback to in-memory
                    window.__tempNotes = notes;
                    this.updateStorageStatus('memory');
                    return true;
                }
            }

            load() {
                if (this.isStorageAvailable) {
                    try {
                        const data = localStorage.getItem(this.notesKey);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('Failed to load from localStorage:', e);
                        return null;
                    }
                } else {
                    return window.__tempNotes || null;
                }
            }

            saveCategories(categories) {
                if (this.isStorageAvailable) {
                    try {
                        localStorage.setItem(this.categoriesKey, JSON.stringify(categories));
                        return true;
                    } catch (e) {
                        console.error('Failed to save categories:', e);
                        return false;
                    }
                } else {
                    window.__tempCategories = categories;
                    return true;
                }
            }

            loadCategories() {
                if (this.isStorageAvailable) {
                    try {
                        const data = localStorage.getItem(this.categoriesKey);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('Failed to load categories:', e);
                        return null;
                    }
                } else {
                    return window.__tempCategories || null;
                }
            }

            saveTheme(theme) {
                if (this.isStorageAvailable) {
                    try {
                        localStorage.setItem(this.themeKey, theme);
                        return true;
                    } catch (e) {
                        console.error('Failed to save theme:', e);
                        return false;
                    }
                } else {
                    window.__tempTheme = theme;
                    return true;
                }
            }

            loadTheme() {
                if (this.isStorageAvailable) {
                    try {
                        return localStorage.getItem(this.themeKey);
                    } catch (e) {
                        console.error('Failed to load theme:', e);
                        return null;
                    }
                } else {
                    return window.__tempTheme || null;
                }
            }

            updateStorageStatus(status) {
                const indicator = document.getElementById('storageIndicator');
                const text = document.getElementById('storageText');
                
                switch(status) {
                    case 'saved':
                        indicator.className = 'storage-indicator';
                        text.textContent = 'Saved';
                        break;
                    case 'memory':
                        indicator.className = 'storage-indicator warning';
                        text.textContent = 'In-Memory Only';
                        break;
                    case 'error':
                        indicator.className = 'storage-indicator warning';
                        text.textContent = 'Storage Error';
                        break;
                }
            }

            getStorageSize() {
                if (this.isStorageAvailable) {
                    let total = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            total += localStorage[key].length + key.length;
                        }
                    }
                    return (total / 1024).toFixed(2) + ' KB';
                }
                return '0 KB';
            }
        }

        // Initialize storage manager
        const storage = new StorageManager();
        
        // Notes management
        let notes = [];
        let currentNoteId = null;
        let autoSaveTimeout = null;
        let searchTerm = '';
        let currentViewMode = 'edit'; // 'edit' or 'preview'
        let activeCategory = 'all'; // Current category filter

        // Default categories configuration
        const defaultCategories = [
            { id: 'api', label: 'API', icon: '🔌', color: '#f59e0b' },
            { id: 'config', label: 'Config', icon: '⚙️', color: '#10b981' },
            { id: 'snippet', label: 'Snippet', icon: '📋', color: '#6366f1' },
            { id: 'docs', label: 'Docs', icon: '📚', color: '#8b5cf6' },
            { id: 'notes', label: 'Notes', icon: '📝', color: '#06b6d4' },
            { id: 'security', label: 'Security', icon: '🔐', color: '#ef4444' },
            { id: 'database', label: 'Database', icon: '💾', color: '#ec4899' },
            { id: 'other', label: 'Other', icon: '📁', color: '#71717a' }
        ];

        // Categories will be loaded from storage or use defaults
        let categories = [...defaultCategories];

        // Supported languages for syntax highlighting
        const languages = [
            { value: 'plaintext', label: 'Plain Text' },
            { value: 'javascript', label: 'JavaScript' },
            { value: 'typescript', label: 'TypeScript' },
            { value: 'jsx', label: 'JSX/React' },
            { value: 'tsx', label: 'TSX' },
            { value: 'python', label: 'Python' },
            { value: 'java', label: 'Java' },
            { value: 'csharp', label: 'C#' },
            { value: 'go', label: 'Go' },
            { value: 'rust', label: 'Rust' },
            { value: 'php', label: 'PHP' },
            { value: 'sql', label: 'SQL' },
            { value: 'bash', label: 'Bash/Shell' },
            { value: 'yaml', label: 'YAML' },
            { value: 'json', label: 'JSON' },
            { value: 'markdown', label: 'Markdown' },
            { value: 'css', label: 'CSS' },
            { value: 'html', label: 'HTML' },
            { value: 'docker', label: 'Dockerfile' }
        ];

        // Initialize app
        function initializeApp() {
            // Load saved theme or detect system preference
            const savedTheme = storage.loadTheme();
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
            } else {
                // No saved theme, check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = prefersDark ? 'dark' : 'light';
                document.body.setAttribute('data-theme', theme);
                // Don't save it yet - let user make explicit choice
            }
            
            // Load saved categories
            const savedCategories = storage.loadCategories();
            if (savedCategories && savedCategories.length > 0) {
                categories = savedCategories;
            } else {
                // Save default categories on first run
                storage.saveCategories(categories);
            }
            
            // Apply dynamic category styles
            updateCategoryStyles();
            
            // Try to load saved notes
            const savedNotes = storage.load();
            
            if (savedNotes && savedNotes.length > 0) {
                // Ensure backward compatibility
                notes = savedNotes.map(note => ({
                    ...note,
                    category: note.category || 'other',
                    tags: note.tags || []
                }));
                saveNotes();
                renderCategoryFilters();
                renderNotesList();
                // Select the first note
                selectNote(notes[0].id);
            } else {
                // Create welcome note for first-time users
                notes = [
                    {
                        id: Date.now(),
                        title: "Welcome to Dev Notes v3.5",
                        content: `# Welcome to Dev Notes v3.5 🚀

## ✨ What's New

### v3.5 - Theme System 🌓
Perfect visibility in any environment!

- **☀️ Light Mode** - Bright, clean interface for daytime work
- **🌙 Dark Mode** - Easy on the eyes for late-night coding
- **🎨 Smooth Transitions** - Beautiful theme switching animations
- **💾 Theme Persistence** - Remembers your preference
- **⌨️ Quick Toggle** - Press **Ctrl/Cmd + D** to switch themes
- **🔄 Auto Detection** - Respects system theme preference

### Theme Features

**Light Mode Benefits:**
- Better for bright environments
- Easier to read in sunlight
- Professional appearance for presentations
- Reduced eye strain during daytime

**Dark Mode Benefits:**
- Reduced eye strain in low light
- Better for extended coding sessions
- Saves battery on OLED screens
- Preferred by most developers

### Quick Theme Toggle

You can switch themes in three ways:
1. Click the **theme toggle** in the header
2. Press **Ctrl/Cmd + D** for instant switching
3. Theme automatically saves your preference

### All Features
- 🌓 **Theme System** - Light/Dark modes (v3.5)
- 🎨 **Custom Categories** - Personalized organization (v3.4)
- ⌨️ **Keyboard Shortcuts** - Power user controls (v3.3)
- 🏷️ **Tags & Categories** - Flexible organization (v3.2)
- 📝 **Markdown Support** - Rich documentation (v3.1)
- 🎨 **Syntax Highlighting** - Beautiful code (v3.0)
- 💾 **Persistent Storage** - Never lose data (v2.0)

## 🎯 Complete Workflow

\`\`\`javascript
// Perfect Development Environment
// 1. Set theme based on time of day
// 2. Create categorized notes
// 3. Use markdown for documentation
// 4. Navigate with keyboard shortcuts
// 5. Switch themes as lighting changes

const devWorkflow = {
    morning: 'light-theme',
    evening: 'dark-theme',
    categories: ['API', 'Config', 'Snippets'],
    shortcuts: 'Ctrl+N, Ctrl+E, Ctrl+D',
    productivity: 'maximized'
};
\`\`\`

## 💡 Pro Tips

- **Auto Theme**: Your theme choice is saved automatically
- **Eye Comfort**: Switch to dark mode for evening work
- **Presentation**: Use light mode when sharing screen
- **Battery Save**: Dark mode uses less power on OLED
- **Quick Switch**: Ctrl/Cmd + D instantly toggles theme

---

*Your perfect coding environment, day or night! 🌞🌙*`,
                        language: 'markdown',
                        category: 'docs',
                        tags: ['welcome', 'tutorial', 'themes', 'features'],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                saveNotes();
                renderCategoryFilters();
                renderNotesList();
                selectNote(notes[0].id);
            }
            
            // Initialize keyboard shortcuts
            initializeKeyboardShortcuts();
        }

        // Save notes to storage
        function saveNotes() {
            storage.save(notes);
        }

        // Create a new note
        function createNewNote() {
            const note = {
                id: Date.now(),
                title: "Untitled Note",
                content: "",
                language: "plaintext",
                category: "other",
                tags: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            notes.unshift(note);
            saveNotes();
            renderNotesList();
            selectNote(note.id);
            
            // Focus on title input
            setTimeout(() => {
                const titleInput = document.getElementById('noteTitleInput');
                if (titleInput) {
                    titleInput.select();
                }
            }, 100);
        }

        // Search notes
        function searchNotes(term) {
            searchTerm = term.toLowerCase();
            renderNotesList();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            renderNotesList();
        }

        // Get filtered notes based on search and category
        function getFilteredNotes() {
            let filtered = notes;
            
            // Filter by category
            if (activeCategory !== 'all') {
                filtered = filtered.filter(note => note.category === activeCategory);
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(note => 
                    note.title.toLowerCase().includes(searchTerm) ||
                    note.content.toLowerCase().includes(searchTerm) ||
                    (note.tags && note.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }
            
            return filtered;
        }

        // Set category filter
        function setCategoryFilter(category) {
            activeCategory = category;
            renderCategoryFilters();
            renderNotesList();
        }

        // Render category filters
        function renderCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            if (!container) return;
            
            const categoryCounts = {};
            categories.forEach(cat => {
                categoryCounts[cat.id] = notes.filter(n => n.category === cat.id).length;
            });
            
            container.innerHTML = `
                <button 
                    class="category-filter all ${activeCategory === 'all' ? 'active' : ''}"
                    onclick="setCategoryFilter('all')"
                    ${activeCategory === 'all' ? `style="background: var(--accent); border-color: var(--accent);"` : ''}
                >
                    📂 All
                    <span class="category-count">${notes.length}</span>
                </button>
                ${categories.map(cat => `
                    <button 
                        class="category-filter ${activeCategory === cat.id ? 'active' : ''}"
                        data-category="${cat.id}"
                        onclick="setCategoryFilter('${cat.id}')"
                        ${activeCategory === cat.id ? `style="background: ${cat.color}; border-color: ${cat.color}; color: white;"` : ''}
                    >
                        ${cat.icon} ${cat.label}
                        ${categoryCounts[cat.id] > 0 ? `<span class="category-count">${categoryCounts[cat.id]}</span>` : ''}
                    </button>
                `).join('')}
            `;
        }

        // Calculate note size
        function getNoteSize(note) {
            const size = JSON.stringify(note).length;
            if (size < 1024) return size + ' B';
            return (size / 1024).toFixed(1) + ' KB';
        }

        // Render notes list
        function renderNotesList() {
            const notesList = document.getElementById('notesList');
            const noteStats = document.getElementById('noteStats');
            const filteredNotes = getFilteredNotes();
            
            if (notes.length === 0) {
                notesList.innerHTML = '';
                noteStats.textContent = 'No notes yet';
                return;
            }
            
            const totalSize = storage.getStorageSize();
            noteStats.textContent = `${notes.length} note${notes.length !== 1 ? 's' : ''} • ${totalSize}`;
            
            if (filteredNotes.length === 0) {
                notesList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No notes found</div>';
                return;
            }
            
            notesList.innerHTML = filteredNotes.map(note => {
                const description = note.content.substring(0, 50) || 'Empty note';
                const isActive = note.id === currentNoteId ? 'active' : '';
                const date = new Date(note.updatedAt).toLocaleDateString();
                const size = getNoteSize(note);
                const category = categories.find(c => c.id === note.category) || 
                               categories.find(c => c.id === 'other') || 
                               { id: 'other', label: 'Other', icon: '📁', color: '#71717a' };
                
                return `
                    <div class="note-item ${isActive}" onclick="selectNote(${note.id})">
                        <button class="delete-note-btn" onclick="deleteNote(event, ${note.id})">✕</button>
                        <div class="note-item-title">${escapeHtml(note.title)}</div>
                        <div class="note-item-description">${escapeHtml(description)}</div>
                        ${note.tags && note.tags.length > 0 ? `
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="note-tag">#${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="note-category-badge" style="background: ${category.color}; color: white;">
                            ${category.label}
                        </div>
                        <div class="note-item-meta">
                            <div class="note-item-date">${date}</div>
                            <div class="note-item-size">${size}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select a note
        function selectNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            currentNoteId = noteId;
            currentViewMode = 'edit'; // Reset to edit mode when selecting a note
            renderNotesList();
            
            // Ensure note has required properties (for backward compatibility)
            if (!note.language) note.language = 'plaintext';
            if (!note.category) note.category = 'other';
            if (!note.tags) note.tags = [];
            
            const canvasContent = document.getElementById('canvasContent');
            canvasContent.innerHTML = `
                <div class="canvas-header">
                    <input 
                        type="text" 
                        class="note-title-input" 
                        id="noteTitleInput"
                        value="${escapeHtml(note.title)}" 
                        placeholder="Note title..."
                        oninput="updateNoteTitle(this.value)"
                    />
                    <div class="editor-controls">
                        <select 
                            class="category-selector" 
                            id="categorySelector"
                            onchange="updateNoteCategory(this.value)"
                        >
                            ${categories.map(cat => 
                                `<option value="${cat.id}" ${note.category === cat.id ? 'selected' : ''}>
                                    ${cat.icon} ${cat.label}
                                </option>`
                            ).join('')}
                        </select>
                        <select 
                            class="language-selector" 
                            id="languageSelector"
                            onchange="updateNoteLanguage(this.value)"
                        >
                            ${languages.map(lang => 
                                `<option value="${lang.value}" ${note.language === lang.value ? 'selected' : ''}>
                                    ${lang.label}
                                </option>`
                            ).join('')}
                        </select>
                        <div class="view-toggle">
                            <button 
                                class="active" 
                                id="editBtn"
                                onclick="setViewMode('edit')"
                            >Edit</button>
                            <button 
                                id="previewBtn"
                                onclick="setViewMode('preview')"
                            >Preview</button>
                        </div>
                    </div>
                    <span class="save-indicator" id="saveIndicator">Saved</span>
                </div>
                <div style="padding: 0 1.5rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border);">
                    <div class="tags-input-container" style="padding: 0.75rem 0;">
                        <input 
                            type="text" 
                            class="tags-input" 
                            id="tagsInput"
                            placeholder="Add tags (press Enter)..."
                            onkeypress="handleTagInput(event)"
                        />
                        <div class="tags-list" id="tagsList">
                            ${note.tags.map(tag => `
                                <span class="tag-item">
                                    ${escapeHtml(tag)}
                                    <button class="tag-remove" onclick="removeTag('${escapeHtml(tag)}')">×</button>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="note-editor-container" id="editorContainer">
                    <textarea 
                        class="note-editor" 
                        id="noteEditor"
                        placeholder="Start typing your note..."
                        oninput="updateNoteContent(this.value)"
                    >${escapeHtml(note.content)}</textarea>
                </div>
            `;
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        }

        // Update note category
        function updateNoteCategory(category) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.category = category;
                note.updatedAt = new Date().toISOString();
                saveNotes();
                renderCategoryFilters();
                renderNotesList();
                showSaveIndicator();
            }
        }

        // Handle tag input
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const tag = input.value.trim();
                
                if (tag && currentNoteId) {
                    const note = notes.find(n => n.id === currentNoteId);
                    if (note && !note.tags.includes(tag)) {
                        note.tags.push(tag);
                        note.updatedAt = new Date().toISOString();
                        saveNotes();
                        renderNotesList();
                        showSaveIndicator();
                        
                        // Update tags display
                        const tagsList = document.getElementById('tagsList');
                        tagsList.innerHTML += `
                            <span class="tag-item">
                                ${escapeHtml(tag)}
                                <button class="tag-remove" onclick="removeTag('${escapeHtml(tag)}')">×</button>
                            </span>
                        `;
                        
                        input.value = '';
                    }
                }
            }
        }

        // Remove tag
        function removeTag(tag) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.tags = note.tags.filter(t => t !== tag);
                note.updatedAt = new Date().toISOString();
                saveNotes();
                renderNotesList();
                showSaveIndicator();
                
                // Re-render tags
                const tagsList = document.getElementById('tagsList');
                tagsList.innerHTML = note.tags.map(t => `
                    <span class="tag-item">
                        ${escapeHtml(t)}
                        <button class="tag-remove" onclick="removeTag('${escapeHtml(t)}')">×</button>
                    </span>
                `).join('');
            }
        }

        // Set view mode (edit or preview)
        function setViewMode(mode) {
            if (!currentNoteId) return;
            
            currentViewMode = mode;
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;
            
            const editBtn = document.getElementById('editBtn');
            const previewBtn = document.getElementById('previewBtn');
            const container = document.getElementById('editorContainer');
            
            if (mode === 'edit') {
                editBtn.classList.add('active');
                previewBtn.classList.remove('active');
                
                container.innerHTML = `
                    <textarea 
                        class="note-editor" 
                        id="noteEditor"
                        placeholder="Start typing your note..."
                        oninput="updateNoteContent(this.value)"
                    >${escapeHtml(note.content)}</textarea>
                `;
            } else {
                editBtn.classList.remove('active');
                previewBtn.classList.add('active');
                
                // Handle markdown rendering
                if (note.language === 'markdown') {
                    // Configure marked options
                    marked.setOptions({
                        highlight: function(code, lang) {
                            if (lang && Prism.languages[lang]) {
                                return Prism.highlight(code, Prism.languages[lang], lang);
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true,
                        tables: true,
                        pedantic: false,
                        sanitize: false,
                        smartLists: true,
                        smartypants: true
                    });
                    
                    // Parse markdown to HTML
                    const markdownHtml = marked.parse(note.content);
                    container.innerHTML = `<div class="markdown-preview">${markdownHtml}</div>`;
                    
                    // Apply syntax highlighting to code blocks
                    Prism.highlightAllUnder(container);
                } else if (note.language !== 'plaintext') {
                    // Regular code with syntax highlighting
                    const escaped = escapeHtml(note.content);
                    const highlightedCode = `<pre><code class="language-${note.language}">${escaped}</code></pre>`;
                    
                    container.innerHTML = `<div class="code-preview">${highlightedCode}</div>`;
                    
                    // Apply Prism highlighting
                    Prism.highlightAll();
                } else {
                    // Plain text - just show it with proper formatting
                    container.innerHTML = `<div class="code-preview"><pre>${escapeHtml(note.content)}</pre></div>`;
                }
            }
        }

        // Update note language
        function updateNoteLanguage(language) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.language = language;
                note.updatedAt = new Date().toISOString();
                saveNotes();
                showSaveIndicator();
                
                // If in preview mode, refresh the preview
                if (currentViewMode === 'preview') {
                    setViewMode('preview');
                }
            }
        }

        // Update note title
        function updateNoteTitle(title) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.title = title;
                note.updatedAt = new Date().toISOString();
                saveNotes();
                renderNotesList();
                showSaveIndicator();
            }
        }

        // Update note content
        function updateNoteContent(content) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.content = content;
                note.updatedAt = new Date().toISOString();
                saveNotes();
                renderNotesList();
                showSaveIndicator();
            }
        }

        // Delete a note
        function deleteNote(event, noteId) {
            event.stopPropagation();
            
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(n => n.id !== noteId);
                saveNotes();
                
                if (currentNoteId === noteId) {
                    currentNoteId = null;
                    document.getElementById('canvasContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <div class="empty-state-text">No note selected</div>
                            <div class="empty-state-subtext">Create a new note or select an existing one</div>
                        </div>
                    `;
                }
                
                renderNotesList();
            }
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Export notes
        function exportNotes() {
            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dev-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${notes.length} notes successfully!`);
        }

        // Import notes
        function importNotes(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedNotes)) {
                        throw new Error('Invalid file format');
                    }
                    
                    // Add missing properties to imported notes (backward compatibility)
                    importedNotes.forEach(note => {
                        if (!note.language) note.language = 'plaintext';
                        if (!note.category) note.category = 'other';
                        if (!note.tags) note.tags = [];
                    });
                    
                    const confirmMsg = `Import ${importedNotes.length} notes? This will replace all existing notes.`;
                    if (confirm(confirmMsg)) {
                        notes = importedNotes;
                        saveNotes();
                        renderCategoryFilters();
                        renderNotesList();
                        if (notes.length > 0) {
                            selectNote(notes[0].id);
                        }
                        closeImportExportModal();
                        alert('Notes imported successfully!');
                    }
                } catch (error) {
                    alert('Failed to import notes. Please ensure the file is a valid JSON export.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Modal functions
        function showImportExportModal() {
            document.getElementById('importExportModal').classList.add('show');
        }

        function closeImportExportModal() {
            document.getElementById('importExportModal').classList.remove('show');
            document.getElementById('importFile').value = '';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('show');
        }

        // Initialize app when DOM is ready
        window.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // Watch for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't manually set a preference
            if (!storage.loadTheme()) {
                const theme = e.matches ? 'dark' : 'light';
                document.body.setAttribute('data-theme', theme);
                showThemeNotification(theme);
            }
        });

        // Drag and drop for import
        const modal = document.getElementById('importExportModal');
        modal.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        modal.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/json') {
                importNotes(files[0]);
            }
        });

        // Keyboard Shortcuts Implementation
        function initializeKeyboardShortcuts() {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modKey = isMac ? 'metaKey' : 'ctrlKey';
            
            document.addEventListener('keydown', (e) => {
                // Show shortcuts modal with '?'
                if (e.key === '?' && !isInputFocused()) {
                    e.preventDefault();
                    showShortcutsModal();
                    return;
                }
                
                // Close modals with Escape
                if (e.key === 'Escape') {
                    closeAllModals();
                    return;
                }
                
                // Check for modifier key (Ctrl/Cmd)
                if (e[modKey]) {
                    switch(e.key.toLowerCase()) {
                        case 'n': // New note
                            e.preventDefault();
                            createNewNote();
                            showNotification('New note created');
                            break;
                            
                        case 's': // Save (visual feedback)
                            e.preventDefault();
                            if (currentNoteId) {
                                saveNotes();
                                showSaveIndicator();
                                showNotification('Note saved');
                            }
                            break;
                            
                        case 'd': // Toggle theme
                            e.preventDefault();
                            toggleTheme();
                            break;
                            
                        case 'e': // Toggle Edit/Preview
                            e.preventDefault();
                            if (currentNoteId) {
                                toggleViewMode();
                            }
                            break;
                            
                        case '/': // Focus search
                            e.preventDefault();
                            focusSearch();
                            break;
                            
                        case 'delete': // Delete current note
                        case 'backspace': // Also support backspace
                            if (e.shiftKey && currentNoteId && !isInputFocused()) {
                                e.preventDefault();
                                if (confirm('Delete current note?')) {
                                    deleteCurrentNote();
                                }
                            }
                            break;
                            
                        case 'i': // Import/Export
                            e.preventDefault();
                            showImportExportModal();
                            break;
                            
                        case 't': // Focus title
                            e.preventDefault();
                            focusTitle();
                            break;
                            
                        case 'f': // Focus editor
                            e.preventDefault();
                            if (!e.shiftKey) { // Avoid conflict with browser find
                                focusEditor();
                            }
                            break;
                            
                        case 'g': // Add tag
                            e.preventDefault();
                            focusTags();
                            break;
                            
                        case 'm': // Manage categories
                            e.preventDefault();
                            showCategoryModal();
                            break;
                    }
                }
                
                // Alt + Arrow navigation
                if (e.altKey) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectNextNote();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectPreviousNote();
                    }
                }
            });
        }

        // Check if an input/textarea is focused
        function isInputFocused() {
            const activeElement = document.activeElement;
            return activeElement && (
                activeElement.tagName === 'INPUT' || 
                activeElement.tagName === 'TEXTAREA' || 
                activeElement.tagName === 'SELECT'
            );
        }

        // Show action notification
        function showNotification(message) {
            const notification = document.getElementById('actionNotification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // Toggle view mode
        function toggleViewMode() {
            const newMode = currentViewMode === 'edit' ? 'preview' : 'edit';
            setViewMode(newMode);
            showNotification(`Switched to ${newMode} mode`);
        }

        // Focus search input
        function focusSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                showNotification('Search focused');
            }
        }

        // Focus title input
        function focusTitle() {
            const titleInput = document.getElementById('noteTitleInput');
            if (titleInput) {
                titleInput.focus();
                titleInput.select();
                showNotification('Title focused');
            }
        }

        // Focus editor
        function focusEditor() {
            const editor = document.getElementById('noteEditor');
            if (editor) {
                editor.focus();
                showNotification('Editor focused');
            }
        }

        // Focus tags input
        function focusTags() {
            const tagsInput = document.getElementById('tagsInput');
            if (tagsInput) {
                tagsInput.focus();
                showNotification('Tags focused');
            }
        }

        // Select next note
        function selectNextNote() {
            const filteredNotes = getFilteredNotes();
            if (filteredNotes.length === 0) return;
            
            const currentIndex = filteredNotes.findIndex(n => n.id === currentNoteId);
            const nextIndex = (currentIndex + 1) % filteredNotes.length;
            selectNote(filteredNotes[nextIndex].id);
            showNotification('Next note');
        }

        // Select previous note
        function selectPreviousNote() {
            const filteredNotes = getFilteredNotes();
            if (filteredNotes.length === 0) return;
            
            const currentIndex = filteredNotes.findIndex(n => n.id === currentNoteId);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : filteredNotes.length - 1;
            selectNote(filteredNotes[prevIndex].id);
            showNotification('Previous note');
        }

        // Delete current note
        function deleteCurrentNote() {
            if (!currentNoteId) return;
            
            const noteToDelete = currentNoteId;
            const noteTitle = notes.find(n => n.id === noteToDelete)?.title || 'Note';
            
            // Find next note to select
            const filteredNotes = getFilteredNotes();
            const currentIndex = filteredNotes.findIndex(n => n.id === noteToDelete);
            let nextNoteId = null;
            
            if (filteredNotes.length > 1) {
                if (currentIndex < filteredNotes.length - 1) {
                    nextNoteId = filteredNotes[currentIndex + 1].id;
                } else if (currentIndex > 0) {
                    nextNoteId = filteredNotes[currentIndex - 1].id;
                }
            }
            
            // Delete the note
            notes = notes.filter(n => n.id !== noteToDelete);
            saveNotes();
            renderCategoryFilters();
            renderNotesList();
            
            // Select next note or show empty state
            if (nextNoteId) {
                selectNote(nextNoteId);
            } else {
                currentNoteId = null;
                document.getElementById('canvasContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No note selected</div>
                        <div class="empty-state-subtext">Create a new note or select an existing one</div>
                    </div>
                `;
            }
            
            showNotification(`Deleted: ${noteTitle}`);
        }

        // Show shortcuts modal
        function showShortcutsModal() {
            document.getElementById('shortcutsModal').classList.add('show');
        }

        // Close shortcuts modal
        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').classList.remove('show');
        }

        // Close all modals
        function closeAllModals() {
            closeShortcutsModal();
            closeImportExportModal();
            closeCategoryModal();
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            storage.saveTheme(newTheme);
            
            // Show theme notification
            showThemeNotification(newTheme);
        }

        function showThemeNotification(theme) {
            const notification = document.getElementById('themeNotification');
            const icon = theme === 'dark' ? '🌙' : '☀️';
            const text = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            
            notification.innerHTML = `${icon} ${text} Activated`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // Category Management Functions
        function showCategoryModal() {
            renderCategoryList();
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
        }

        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = categories.map((cat, index) => `
                <div class="category-item-edit" data-index="${index}">
                    <input 
                        type="text" 
                        class="category-icon-input" 
                        value="${cat.icon}"
                        maxlength="2"
                        onchange="updateCategory(${index}, 'icon', this.value)"
                    />
                    <input 
                        type="text" 
                        class="category-name-input" 
                        value="${cat.label}"
                        onchange="updateCategory(${index}, 'label', this.value)"
                    />
                    <input 
                        type="color" 
                        class="category-color-input" 
                        value="${cat.color || '#71717a'}"
                        onchange="updateCategory(${index}, 'color', this.value)"
                    />
                    <div class="category-actions">
                        ${cat.id !== 'other' ? `
                            <button class="category-btn category-btn-delete" onclick="deleteCategory('${cat.id}')">
                                Delete
                            </button>
                        ` : '<span style="color: var(--text-secondary); font-size: 0.85rem;">Default</span>'}
                    </div>
                </div>
            `).join('');
        }

        function updateCategory(index, field, value) {
            categories[index][field] = value;
            storage.saveCategories(categories);
            updateCategoryStyles();
            renderCategoryFilters();
            renderNotesList();
            
            // Update the current note's category selector if open
            if (currentNoteId) {
                const selector = document.getElementById('categorySelector');
                if (selector) {
                    const currentValue = selector.value;
                    selector.innerHTML = categories.map(cat => 
                        `<option value="${cat.id}" ${currentValue === cat.id ? 'selected' : ''}>
                            ${cat.icon} ${cat.label}
                        </option>`
                    ).join('');
                }
            }
        }

        function addNewCategory() {
            const icon = document.getElementById('newCategoryIcon').value || '📁';
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value;
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            // Generate ID from name
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            // Check if ID already exists
            if (categories.find(c => c.id === id)) {
                alert('A category with this name already exists');
                return;
            }
            
            // Add new category
            categories.push({
                id: id,
                label: name,
                icon: icon,
                color: color
            });
            
            // Save and update
            storage.saveCategories(categories);
            updateCategoryStyles();
            renderCategoryFilters();
            renderCategoryList();
            
            // Clear inputs
            document.getElementById('newCategoryIcon').value = '📁';
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryColor').value = '#71717a';
            
            showNotification(`Category "${name}" added`);
        }

        function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Count notes in this category
            const notesInCategory = notes.filter(n => n.category === categoryId).length;
            
            let confirmMsg = `Delete category "${category.label}"?`;
            if (notesInCategory > 0) {
                confirmMsg += `\n\n${notesInCategory} note(s) will be moved to "Other" category.`;
            }
            
            if (confirm(confirmMsg)) {
                // Move notes to 'other' category
                notes.forEach(note => {
                    if (note.category === categoryId) {
                        note.category = 'other';
                    }
                });
                
                // Remove category
                categories = categories.filter(c => c.id !== categoryId);
                
                // Save everything
                saveNotes();
                storage.saveCategories(categories);
                updateCategoryStyles();
                renderCategoryFilters();
                renderCategoryList();
                renderNotesList();
                
                // Update current note if affected
                if (currentNoteId) {
                    const currentNote = notes.find(n => n.id === currentNoteId);
                    if (currentNote && currentNote.category === 'other') {
                        selectNote(currentNoteId);
                    }
                }
                
                showNotification(`Category "${category.label}" deleted`);
            }
        }

        function restoreDefaultCategories() {
            if (confirm('Restore default categories? This will replace all custom categories.')) {
                categories = [...defaultCategories];
                storage.saveCategories(categories);
                updateCategoryStyles();
                renderCategoryFilters();
                renderCategoryList();
                renderNotesList();
                showNotification('Default categories restored');
            }
        }

        function selectPresetColor(color) {
            document.getElementById('newCategoryColor').value = color;
            
            // Update visual selection
            document.querySelectorAll('.preset-color').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        }

        function updateCategoryStyles() {
            // Create or update style element for dynamic category colors
            let styleEl = document.getElementById('dynamicCategoryStyles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamicCategoryStyles';
                document.head.appendChild(styleEl);
            }
            
            const styles = categories.map(cat => `
                .category-filter[data-category="${cat.id}"].active {
                    background: ${cat.color};
                    border-color: ${cat.color};
                }
                .note-category-badge.${cat.id} {
                    background: ${cat.color};
                    color: white;
                }
            `).join('\n');
            
            styleEl.textContent = styles;
        }
    </script>
</body>
</html>